name: Build documentation

on:
  pull_request_target:
    branches:
      - main
    paths:
      - 'docs/**'
      - '.github/workflows/*documentation*.yml'
      - '.github/actions/**'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: "docs-preview-${{ github.event.pull_request.number }}"
  cancel-in-progress: true

jobs:
  Build_Documentation:
    runs-on: ubuntu-24.04
    outputs:
      changed_docs: ${{ steps.changed-files.outputs.docs_files }}
      artifact_url: ${{ steps.artifact-url.outputs.url }}
      build_timestamp: ${{ steps.build-info.outputs.build_timestamp }}
      commit_sha: ${{ steps.build-info.outputs.commit_sha_short }}
      pr_number: ${{ github.event.pull_request.number }}

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Get changed documentation files
        id: changed-files
        uses: ./.github/actions/get-changed-docs
        with:
          base_sha: ${{ github.event.pull_request.base.sha }}
          head_sha: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r docs/requirements-doc.txt

      - name: Install Doxygen and mscgen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen mscgen

      - name: Build Doxygen API documentation
        run: |
          cd docs
          if [ -f Doxyfile ]; then
            doxygen Doxyfile
          fi

      - name: Build Sphinx documentation
        run: |
          cd docs
          sphinx-build -M html . _build_sphinx -W --keep-going

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation-preview-pr-${{ github.event.pull_request.number }}
          path: docs/_build_sphinx/html/
          retention-days: 14

      - name: Generate artifact URL
        id: artifact-url
        run: |
          artifact_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "url=$artifact_url" >> $GITHUB_OUTPUT

      - name: Set build info
        id: build-info
        run: |
          echo "build_timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "commit_sha_short=${{ github.event.pull_request.head.sha }}" | cut -c1-7 >> $GITHUB_OUTPUT
          commit_sha="${{ github.event.pull_request.head.sha }}"
          echo "commit_sha_short=${commit_sha:0:7}" >> $GITHUB_OUTPUT

  Post_Comment:
    needs: Build_Documentation
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate comment body
        uses: ./.github/actions/generate-docs-comment
        with:
          preview_url: ${{ needs.Build_Documentation.outputs.artifact_url }}
          changed_docs: ${{ needs.Build_Documentation.outputs.changed_docs }}
          build_timestamp: ${{ needs.Build_Documentation.outputs.build_timestamp }}
          commit_sha: ${{ needs.Build_Documentation.outputs.commit_sha }}

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ needs.Build_Documentation.outputs.pr_number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## Documentation Preview'

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ needs.Build_Documentation.outputs.pr_number }}
          body-path: comment.md
          edit-mode: replace
